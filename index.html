<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App 登录验证 login </title>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1f25, #2c3e50);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            padding: 20px;
        }

        .container {
            background: rgba(30, 35, 45, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #3498db;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #bdc3c7;
        }

        .info-box {
            background: rgba(44, 62, 80, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }

        .info-row {
            margin: 15px 0;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .label {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .value {
            font-size: 1.1rem;
            word-break: break-all;
        }

        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            margin: 10px 5px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-danger {
            background: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-danger:hover {
            background: #c0392b;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        .btn-success {
            background: #2ecc71;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-success:hover {
            background: #27ae60;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.6);
        }

        .message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        footer {
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 2rem;
            }
        }

        .code-block {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Telegram Web App 登录验证</h1>
        <p class="subtitle">在Telegram Web App环境中获取并验证用户信息</p>

        <div class="message error" id="error-message"></div>
        <div class="message success" id="success-message"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="text-align: center; margin-top: 15px;">正在处理，请稍候...</p>
        </div>

        <div class="info-box">
            <div class="info-row">
                <div class="label">运行环境</div>
                <div class="value" id="environment">正在检测...</div>
            </div>

            <div class="info-row">
                <div class="label">Web App 状态</div>
                <div class="value" id="webapp-status">未初始化</div>
            </div>
        </div>

        <div id="actions">
            <button class="btn" id="init-btn">初始化 Web App</button>
            <button class="btn btn-success" id="login-btn">获取用户信息</button>
            <button class="btn btn-danger" id="close-btn">关闭 Web App</button>
        </div>

        <div class="info-box" id="user-info" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px;">用户信息</h2>

            <div class="info-row">
                <div class="label">用户 ID</div>
                <div class="value" id="user-id"></div>
            </div>

            <div class="info-row">
                <div class="label">用户名</div>
                <div class="value" id="username"></div>
            </div>

            <div class="info-row">
                <div class="label">姓名</div>
                <div class="value" id="fullname"></div>
            </div>

            <div class="info-row">
                <div class="label">语言</div>
                <div class="value" id="language"></div>
            </div>

            <div class="info-row">
                <div class="label">授权时间</div>
                <div class="value" id="auth-date"></div>
            </div>
        </div>

        <div class="info-box" id="initdata-info" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px;">InitData</h2>

            <div class="info-row">
                <div class="label">原始数据</div>
                <div class="code-block" id="raw-initdata"></div>
            </div>

            <div class="info-row">
                <div class="label">解析后的数据</div>
                <div class="code-block" id="parsed-initdata"></div>
            </div>

            <button class="btn" id="verify-btn">验证签名</button>
            <button class="btn" id="login-svr-btn">登录</button>
        </div>

        <footer>
            <p>提示：此页面需要在Telegram客户端内作为Web App打开才能正常工作</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const envEl = document.getElementById('environment');
            const statusEl = document.getElementById('webapp-status');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const loading = document.getElementById('loading');
            const userInfo = document.getElementById('user-info');
            const initdataInfo = document.getElementById('initdata-info');
            const initBtn = document.getElementById('init-btn');
            const loginBtn = document.getElementById('login-btn');
            const closeBtn = document.getElementById('close-btn');
            const verifyBtn = document.getElementById('verify-btn');
            const loginSrvBtn = document.getElementById('login-svr-btn')

            let webApp = null;
            let initData = null;

            // 检测环境
            if (window.Telegram && window.Telegram.WebApp) {
                envEl.textContent = "Telegram Web App 环境";
                statusEl.textContent = "SDK 已加载";
                webApp = window.Telegram.WebApp;
                initBtn.disabled = true;
            } else {
                envEl.textContent = "普通浏览器环境";
                statusEl.textContent = "Telegram SDK 不可用";
                loginBtn.disabled = true;
                closeBtn.disabled = true;
                verifyBtn.disabled = true;
                showError('此功能需要在Telegram客户端内作为Web App打开');
            }

            // 初始化按钮
            initBtn.addEventListener('click', function () {
                if (webApp) {
                    webApp.ready();
                    statusEl.textContent = "Web App 已初始化";
                    showSuccess('Web App 初始化成功');
                    initBtn.disabled = true;
                    loginBtn.disabled = false;
                }
            });

            // 获取用户信息按钮
            loginBtn.addEventListener('click', function () {
                if (!webApp) {
                    showError('Telegram WebApp SDK 不可用');
                    return;
                }

                webApp.expand()

                loading.style.display = 'block';

                try {
                    // 获取 initData
                    initData = webApp.initData || webApp.initDataUnsafe;

                    if (!initData) {
                        showError('无法获取 initData');
                        loading.style.display = 'none';
                        return;
                    }

                    // 显示用户信息
                    displayUserInfo();

                    // 显示 initData
                    displayInitData();

                    loading.style.display = 'none';
                    showSuccess('用户信息获取成功');
                } catch (e) {
                    showError('获取用户信息时出错: ' + e.message);
                    loading.style.display = 'none';
                }
            });

            // 关闭按钮
            closeBtn.addEventListener('click', function () {
                if (webApp) {
                    webApp.close();
                }
            });

            // 验证按钮
            verifyBtn.addEventListener('click', function () {
                if (!initData) {
                    showError('请先获取用户信息');
                    return;
                }

                loading.style.display = 'block';

                // 模拟后端验证（实际应用中应发送到后端）
                setTimeout(() => {
                    const isValid = true; // 这里应该实际验证

                    if (isValid) {
                        showSuccess('签名验证成功！数据完整且有效');
                    } else {
                        showError('签名验证失败！数据可能被篡改');
                    }

                    loading.style.display = 'none';
                }, 1000);
            });

            loginSrvBtn.addEventListener('click', verifyTelegramLogin)

            // 显示用户信息
            function displayUserInfo () {
                const user = webApp.initDataUnsafe.user;

                if (!user) {
                    showError('无法获取用户信息');
                    return;
                }

                document.getElementById('user-id').textContent = user.id || '未知';
                document.getElementById('username').textContent = '@' + (user.username || '未设置');
                document.getElementById('fullname').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || '未提供';
                document.getElementById('language').textContent = user.language_code || '未知';

                // 设置授权时间
                const authDate = new Date(webApp.initDataUnsafe.auth_date * 1000);
                document.getElementById('auth-date').textContent =
                    authDate.toLocaleString() + ` (${webApp.initDataUnsafe.auth_date})`;

                userInfo.style.display = 'block';
            }

            // 显示 initData
            function displayInitData () {
                // 显示原始数据
                document.getElementById('raw-initdata').textContent =
                    typeof initData === 'string' ? initData : JSON.stringify(initData, null, 2);

                // 解析并显示数据
                let parsedData = {};

                if (typeof initData === 'string') {
                    // 解析查询字符串
                    const params = new URLSearchParams(initData);
                    parsedData = Object.fromEntries(params.entries());

                    // 尝试解析JSON字段
                    try {
                        if (parsedData.user) parsedData.user = JSON.parse(parsedData.user);
                        if (parsedData.chat) parsedData.chat = JSON.parse(parsedData.chat);
                        // if (parsedData.chat_type) parsedData.chat_type = JSON.parse(parsedData.chat_type);
                    } catch (e) {
                        console.error('解析JSON字段失败', e);
                    }
                } else {
                    parsedData = initData;
                }

                document.getElementById('parsed-initdata').textContent =
                    JSON.stringify(parsedData, null, 2);

                initdataInfo.style.display = 'block';
            }

            // 显示错误消息
            function showError (message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }

            // 显示成功消息
            function showSuccess (message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
            }

            // 验证Telegram登录
            function verifyTelegramLogin () {
                // 显示加载状态
                loading.style.display = 'block';
                console.log("发送请求：", JSON.stringify({ initData: initData }))
                // 发送验证请求到后端
                fetch('/api/telegram-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ initData: initData })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("登录数据", data)
                        // 隐藏加载状态
                        loading.style.display = 'none';

                        if (data.success) {
                            // 显示成功消息
                            showSuccess('登录成功！');


                            console.log("登录成功", data)
                        } else {
                            // 显示错误消息
                            showError(data.error || '登录失败，请重试');
                        }
                    })
                    .catch(error => {
                        // 隐藏加载状态
                        loading.style.display = 'none';
                        console.log("登录失败", error)

                        // 显示错误消息
                        showError('网络错误: ' + error.message);
                    })
                    .finally(() => {
                        console.log("请求结束")
                    })
            }

            // 如果已经在Telegram环境中，自动初始化
            if (webApp) {
                webApp.ready();
                statusEl.textContent = "Web App 已自动初始化";
                initBtn.disabled = true;
            }
        });
    </script>
</body>

</html>